<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MathMint Quiz Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body { font-family: Arial; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; min-height: 100vh; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: rgba(255,255,255,0.1); padding: 20px; margin: 20px 0; border-radius: 10px; backdrop-filter: blur(10px); }
        button { background: #4facfe; color: white; border: none; padding: 12px 24px; margin: 5px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; }
        button:hover { background: #00f2fe; transform: translateY(-2px); transition: all 0.2s; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button.primary { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        button.success { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        button.large { padding: 20px 40px; font-size: 20px; }
        input { width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid #ddd; font-size: 14px; }
        .result { background: rgba(0,0,0,0.3); padding: 15px; margin-top: 10px; border-radius: 5px; font-family: monospace; font-size: 14px; white-space: pre-wrap; }
        .success { background: rgba(16,185,129,0.3); border-left: 4px solid #10b981; }
        .error { background: rgba(239,68,68,0.3); border-left: 4px solid #ef4444; }
        .warning { background: rgba(251,191,36,0.3); border-left: 4px solid #fbbf24; }
        .hidden { display: none; }
        h1 { text-align: center; font-size: 2.5em; margin-bottom: 10px; }
        h2 { border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 10px; margin-bottom: 15px; }
        .subtitle { text-align: center; opacity: 0.9; margin-bottom: 30px; }
        .info-box { background: rgba(59,130,246,0.2); border: 1px solid rgba(59,130,246,0.4); padding: 12px; border-radius: 5px; margin: 10px 0; font-size: 14px; }
        .network-badge { display: inline-block; padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: bold; margin: 5px 0; }
        .network-correct { background: rgba(16,185,129,0.3); color: #10b981; }
        .network-wrong { background: rgba(239,68,68,0.3); color: #ef4444; }
        .step { margin: 15px 0; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px; }
        .step-number { display: inline-block; width: 25px; height: 25px; background: #4facfe; border-radius: 50%; text-align: center; line-height: 25px; margin-right: 10px; font-weight: bold; }
        
        /* Quiz Styles */
        .quiz-container { text-align: center; }
        .quiz-question { font-size: 3em; font-weight: bold; margin: 30px 0; }
        .quiz-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .quiz-option { padding: 20px; font-size: 1.5em; font-weight: bold; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3); border-radius: 10px; cursor: pointer; transition: all 0.2s; }
        .quiz-option:hover { background: rgba(255,255,255,0.3); transform: scale(1.05); }
        .quiz-option.correct { background: rgba(16,185,129,0.5); border-color: #10b981; }
        .quiz-option.wrong { background: rgba(239,68,68,0.5); border-color: #ef4444; }
        .quiz-timer { font-size: 2em; font-weight: bold; margin: 20px 0; }
        .quiz-timer.warning { color: #fbbf24; animation: pulse 1s infinite; }
        .quiz-progress { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 10px; margin: 20px 0; }
        .quiz-progress-bar { height: 10px; background: linear-gradient(90deg, #4facfe, #00f2fe); border-radius: 5px; transition: width 0.3s; }
        .quiz-stats { display: flex; justify-content: space-around; margin: 20px 0; font-size: 1.2em; }
        .quiz-stat { text-align: center; }
        .quiz-stat-value { font-size: 2em; font-weight: bold; display: block; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Welcome Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; padding: 40px; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.5); animation: modalSlideIn 0.4s ease-out; position: relative; }
        .modal h2 { font-size: 2em; margin-bottom: 20px; text-align: center; border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 15px; }
        .modal-content { line-height: 1.6; }
        .modal-section { background: rgba(255,255,255,0.1); padding: 15px; margin: 15px 0; border-radius: 10px; border-left: 4px solid #4facfe; }
        .modal-section h3 { margin-top: 0; font-size: 1.3em; }
        .modal-tips { list-style: none; padding: 0; }
        .modal-tips li { padding: 10px; margin: 8px 0; background: rgba(0,0,0,0.2); border-radius: 8px; padding-left: 40px; position: relative; }
        .modal-tips li:before { content: '‚ú®'; position: absolute; left: 12px; font-size: 1.2em; }
        .modal-checkbox { margin: 25px 0; padding: 15px; background: rgba(255,215,0,0.1); border: 2px solid rgba(255,215,0,0.3); border-radius: 10px; display: flex; align-items: center; }
        .modal-checkbox input { width: 20px; height: 20px; margin-right: 12px; cursor: pointer; }
        .modal-checkbox label { font-size: 1.1em; font-weight: 600; cursor: pointer; }
        .modal-buttons { display: flex; gap: 15px; margin-top: 25px; }
        .modal-buttons button { flex: 1; padding: 15px; font-size: 1.1em; }
        .security-link { display: block; text-align: center; margin-top: 15px; color: #4facfe; text-decoration: none; font-size: 0.9em; }
        .security-link:hover { text-decoration: underline; }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Tooltip Styles */
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext { visibility: hidden; width: 250px; background-color: rgba(0,0,0,0.9); color: #fff; text-align: left; border-radius: 8px; padding: 12px; position: absolute; z-index: 100; bottom: 125%; left: 50%; margin-left: -125px; opacity: 0; transition: opacity 0.3s; font-size: 13px; line-height: 1.4; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .tooltip .tooltiptext::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: rgba(0,0,0,0.9) transparent transparent transparent; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .info-icon { display: inline-block; width: 18px; height: 18px; background: rgba(74, 172, 254, 0.3); color: #4facfe; border-radius: 50%; text-align: center; line-height: 18px; font-size: 12px; font-weight: bold; cursor: help; margin-left: 5px; border: 1px solid rgba(74, 172, 254, 0.5); }
    </style>
</head>
<body>
    <!-- Welcome to Self-Custody Modal -->
    <div id="welcomeModal" class="modal-overlay hidden">
        <div class="modal">
            <h2>üè¶ Welcome to Your Bank of Good Times!</h2>
            <div class="modal-content">
                <p style="font-size: 1.2em; text-align: center; margin-bottom: 20px;">
                    üéâ <strong>Congratulations!</strong> You're about to become your own bank!
                </p>
                
                <div class="modal-section">
                    <h3>‚ú® What Makes This Special?</h3>
                    <p>Unlike regular banks, <strong>YOU are in complete control</strong>. No middleman, no permissions needed, no one can freeze your funds. This is financial freedom!</p>
                </div>
                
                <div class="modal-section">
                    <h3>üîë 5 Quick Security Tips (30 seconds!)</h3>
                    <ul class="modal-tips">
                        <li><strong>Never share your seed phrase</strong> - Not even with "support"! It's like your master password.</li>
                        <li><strong>Write it on paper</strong> - Not on your phone. Paper can't be hacked!</li>
                        <li><strong>This is testnet</strong> - Safe to learn! Free coins, zero risk.</li>
                        <li><strong>You're in control</strong> - Every transaction needs YOUR approval.</li>
                        <li><strong>Start small</strong> - Test everything before sending large amounts.</li>
                    </ul>
                </div>
                
                <div class="modal-section" style="background: rgba(255,215,0,0.1); border-left-color: #ffd700;">
                    <h3>üí™ You've Got This!</h3>
                    <p>Millions of people use self-custody every day. The difference? They took the first step - just like you're doing now!</p>
                </div>
                
                <div class="modal-checkbox">
                    <input type="checkbox" id="understandCheck">
                    <label for="understandCheck">I understand I'm in control and will keep my seed phrase safe!</label>
                </div>
                
                <div class="modal-buttons">
                    <button onclick="closeWelcomeModal()" style="background: rgba(255,255,255,0.2);">Maybe Later</button>
                    <button id="continueBtn" class="primary" onclick="proceedFromModal()" disabled>Let's Go! üöÄ</button>
                </div>
                
                <a href="../SECURITY_GUIDE.md" target="_blank" class="security-link">
                    üìö Want to learn more? Read our complete Security Guide
                </a>
            </div>
        </div>
    </div>
    <div class="container">
        <h1>üéÆ MathMint Quiz</h1>
        <p class="subtitle">Learn Times Tables & Earn NFTs on Mezo L2</p>
        
        <!-- Step 1: Wallet Connection -->
        <div class="card" id="walletCard">
            <h2>üîê Wallet Connection (Optional)</h2>
            <p>Connect wallet to submit scores, mint NFTs, and view leaderboard</p>
            <p id="status">Not Connected</p>
            <p id="network" class="hidden"></p>
            <p id="address" class="hidden"></p>
            <p id="balance" class="hidden"></p>
            
            <div class="tooltip">
                <button id="connectBtn" class="primary" onclick="showWelcomeModal()">Connect MetaMask üè¶</button>
                <span class="tooltiptext">üéâ First time? We'll show you some quick tips to stay safe!</span>
            </div>
            
            <button id="switchBtn" class="success hidden" onclick="switchNetwork()">Switch to Mezo Testnet</button>
            
            <div class="info-box">
                <strong>‚ÑπÔ∏è Play Without Wallet:</strong> You can play the quiz anytime! Connect only when you want to save scores on blockchain.<br>
                <strong>‚ÑπÔ∏è Need MetaMask?</strong> Install from <a href="https://metamask.io" target="_blank" style="color: #4facfe;">metamask.io</a><br>
                <strong>‚ÑπÔ∏è Need tBTC?</strong> Get from <a href="https://faucet.mezo.org" target="_blank" style="color: #4facfe;">Mezo Faucet</a><br>
                <strong>‚ö° MUSD Boost?</strong> Hold 1+ MUSD to unlock 1.5x point multiplier!<br>
                <strong>üè¶ New to Web3?</strong> We'll show you security tips when you connect - <a href="../SECURITY_GUIDE.md" target="_blank" style="color: #ffd700; font-weight: bold;">or read our Security Guide</a>
            </div>
        </div>

        <!-- Step 2: Play Quiz -->
        <div class="card" id="quizCard">
            <h2>üìä Play Quiz (No Wallet Required!)</h2>
            
            <!-- MUSD Boost Section -->
            <div id="musdBoostSection" class="hidden" style="background: rgba(255,215,0,0.1); border: 2px solid rgba(255,215,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="font-size: 1.1em;">‚ö° MUSD Boost Available!</strong><br>
                        <span style="font-size: 0.9em; opacity: 0.9;">1.5x points multiplier (10 ‚Üí 15 per correct answer)</span><br>
                        <span id="musdBalanceDisplay" style="font-size: 0.85em; color: #ffd700;"></span>
                    </div>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="boostToggle" onchange="toggleBoost()" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;">
                        <span style="font-size: 1.1em; font-weight: bold;">Enable Boost</span>
                    </label>
                </div>
                <div id="boostActiveMsg" class="hidden" style="background: rgba(16,185,129,0.2); padding: 10px; margin-top: 10px; border-radius: 5px; border-left: 4px solid #10b981;">
                    ‚úÖ <strong>Boost Active!</strong> Earning 1.5x points this session
                </div>
            </div>
            
            <!-- Quiz Start Screen -->
            <div id="quizStartScreen" class="quiz-container">
                <p style="font-size: 1.2em; margin: 20px 0;">Answer 5 multiplication questions to earn points!</p>
                <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; margin: 20px 0;">
                    <p>‚úÖ +10 points per correct answer</p>
                    <p>‚ùå -1 point per wrong answer</p>
                    <p>‚è±Ô∏è 15 seconds per question</p>
                </div>
                <button class="primary large" onclick="startQuiz()">Start Quiz!</button>
            </div>
            
            <!-- Quiz Game Screen -->
            <div id="quizGameScreen" class="hidden quiz-container">
                <div class="quiz-progress">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Question <span id="currentQ">1</span> of 5</span>
                        <span class="quiz-timer" id="timer">15</span>
                    </div>
                    <div class="quiz-progress-bar" id="progressBar" style="width: 20%"></div>
                </div>
                
                <div class="quiz-question" id="question">? √ó ? = ?</div>
                
                <div class="quiz-options" id="options">
                    <button class="quiz-option" onclick="selectAnswer(0)">0</button>
                    <button class="quiz-option" onclick="selectAnswer(1)">0</button>
                    <button class="quiz-option" onclick="selectAnswer(2)">0</button>
                    <button class="quiz-option" onclick="selectAnswer(3)">0</button>
                </div>
                
                <div class="quiz-stats">
                    <div class="quiz-stat">
                        <span class="quiz-stat-value" id="correctCount">0</span>
                        <span>Correct</span>
                    </div>
                    <div class="quiz-stat">
                        <span class="quiz-stat-value" id="pointsCount">0</span>
                        <span>Points</span>
                    </div>
                    <div class="quiz-stat">
                        <span class="quiz-stat-value" id="wrongCount">0</span>
                        <span>Wrong</span>
                    </div>
                </div>
            </div>
            
            <!-- Quiz Complete Screen -->
            <div id="quizCompleteScreen" class="hidden quiz-container">
                <h2 style="font-size: 2.5em; margin: 20px 0;">üéâ Quiz Complete!</h2>
                <div class="quiz-stats">
                    <div class="quiz-stat">
                        <span class="quiz-stat-value" id="finalCorrect">0</span>
                        <span>Correct</span>
                    </div>
                    <div class="quiz-stat">
                        <span class="quiz-stat-value" id="finalPoints">0</span>
                        <span>Points Earned</span>
                    </div>
                    <div class="quiz-stat">
                        <span class="quiz-stat-value" id="finalWrong">0</span>
                        <span>Wrong</span>
                    </div>
                </div>
                
                <div id="boostAppliedMsg" class="hidden" style="background: rgba(255,215,0,0.2); padding: 15px; border-radius: 10px; margin: 20px 0;">
                    <strong>‚ö° MUSD Boost Will Be Applied!</strong><br>
                    Your <span id="basePoints">0</span> points will become <span id="boostedPoints">0</span> points when submitted!
                </div>
                
                <div id="walletRequiredMsg" class="hidden" style="background: rgba(251,191,36,0.2); padding: 15px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #fbbf24;">
                    ‚ö†Ô∏è <strong>Wallet Required to Submit Score</strong><br>
                    Connect your wallet above to save your score on the blockchain!
                </div>
                
                <div class="tooltip">
                    <button class="success large" onclick="submitScore()" id="submitScoreBtn">Submit Score to Blockchain 
                        <span class="info-icon">i</span>
                    </button>
                    <span class="tooltiptext">üí™ YOU control this! Each transaction needs YOUR approval. You'll pay a tiny fee - you're running your own bank!</span>
                </div>
                <button class="primary" onclick="playAgain()" style="margin-left: 10px;">Play Again</button>
                
                <div id="quizResult" class="result hidden"></div>
            </div>
        </div>

        <!-- Step 3: NFT Minting -->
        <div class="card" id="nftCard">
            <h2>üé® Mint NFT Badge (Requires Wallet)</h2>
            <div class="step">
                <span class="step-number">3</span>
                Connect wallet and earn 50+ points total to mint your achievement NFT!
            </div>
            <button id="scoreBtn" class="primary" onclick="getScore()">Check My Total Score</button>
            <button id="eligibleBtn" class="primary" onclick="checkEligible()">Check NFT Eligibility</button>
            <div id="scoreResult" class="result hidden"></div>
            
            <div style="margin-top: 20px;">
                <input type="text" id="tokenUri" value="ipfs://QmMathMintBadge/metadata.json" placeholder="Token URI">
                
                <div class="tooltip">
                    <button id="mintBtn" class="success" onclick="mintNFT()">Mint NFT Badge 
                        <span class="info-icon">i</span>
                    </button>
                    <span class="tooltiptext">üé® This NFT is truly YOURS! Once minted, no one can take it away. You OWN it forever.</span>
                </div>
                
                <button id="statusBtn" class="primary" onclick="checkMintStatus()">Check Mint Status</button>
            </div>
            <div id="nftResult" class="result hidden"></div>
            
            <div class="info-box">
                <strong>‚ÑπÔ∏è NFT Info:</strong> Your badge will appear in MetaMask under NFTs tab. Need 50+ points total and 0.001+ tBTC for gas.
            </div>
        </div>

        <!-- Step 4: Leaderboard -->
        <div class="card" id="leaderCard">
            <h2>üèÜ View Leaderboard</h2>
            <button id="leaderBtn" class="primary" onclick="getLeaderboard()">Refresh Leaderboard</button>
            <div id="leaderResult" class="result hidden"></div>
        </div>

        <!-- Contract Info -->
        <div class="card" id="contractCard">
            <h2>üîó Contract Addresses</h2>
            <div style="font-size: 12px; font-family: monospace;">
                <strong>Quiz:</strong> <a href="https://explorer.test.mezo.org/address/0x59bDB59107f29e9712A37c7015ee28675DD7d30f" target="_blank" style="color: #4facfe;">0x59bDB59...DD7d30f</a><br>
                <strong>NFT:</strong> <a href="https://explorer.test.mezo.org/address/0x03672f6b20622176554a4C0ba7B037d9dCE531f0" target="_blank" style="color: #4facfe;">0x03672f6...CE531f0</a><br>
                <strong>MUSD:</strong> <a href="https://explorer.test.mezo.org/address/0x118917a40FAF1CD7a13dB0Ef56C86De7973Ac503" target="_blank" style="color: #4facfe;">0x118917a...973Ac503</a>
            </div>
        </div>
    </div>

    <script>
        const QUIZ_ADDR = "0x59bDB59107f29e9712A37c7015ee28675DD7d30f";
        const NFT_ADDR = "0x03672f6b20622176554a4C0ba7B037d9dCE531f0";
        const MUSD_ADDR = "0x118917a40FAF1CD7a13dB0Ef56C86De7973Ac503";
        
        const MEZO_TESTNET = {
            chainId: '0x7b7b',
            chainName: 'Mezo Testnet',
            nativeCurrency: { name: 'tBTC', symbol: 'tBTC', decimals: 18 },
            rpcUrls: ['https://rpc.test.mezo.org'],
            blockExplorerUrls: ['https://explorer.test.mezo.org']
        };
        
        const QUIZ_ABI = [
            "function updateScore(address user, uint256 points)",
            "function getScore(address user) view returns (uint256)",
            "function canMintNFT(address user) view returns (bool)",
            "function getLeaderboard() view returns (address[], uint256[])"
        ];
        
        const NFT_ABI = [
            "function mintBadge(string memory tokenURI)",
            "function hasUserMinted(address user) view returns (bool)",
            "function getUserTokenId(address user) view returns (uint256)"
        ];
        
        const MUSD_ABI = [
            "function balanceOf(address account) view returns (uint256)",
            "function decimals() view returns (uint8)"
        ];

        let provider, signer, quiz, nft, musd, userAddr, currentChainId;
        let musdBalance = 0;
        let boostEnabled = false;
        
        // Quiz state
        let quizQuestions = [];
        let currentQuestion = 0;
        let correctAnswers = 0;
        let wrongAnswers = 0;
        let points = 0;
        let timerInterval;
        let timeLeft = 15;

        // Welcome Modal Functions
        function showWelcomeModal() {
            // Check if user has already seen the modal
            const hasSeenWelcome = localStorage.getItem('mathMintWelcomeSeen');
            
            if (!hasSeenWelcome) {
                document.getElementById('welcomeModal').classList.remove('hidden');
                
                // Enable continue button when checkbox is checked
                document.getElementById('understandCheck').addEventListener('change', function() {
                    document.getElementById('continueBtn').disabled = !this.checked;
                });
            } else {
                // If already seen, connect directly
                connect();
            }
        }

        function closeWelcomeModal() {
            document.getElementById('welcomeModal').classList.add('hidden');
            // Don't mark as seen if they close without understanding
        }

        function proceedFromModal() {
            // Mark as seen so they don't see it again
            localStorage.setItem('mathMintWelcomeSeen', 'true');
            document.getElementById('welcomeModal').classList.add('hidden');
            // Proceed with wallet connection
            connect();
        }

        async function connect() {
            try {
                if (!window.ethereum) {
                    alert("Please install MetaMask from metamask.io");
                    return;
                }
                
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddr = await signer.getAddress();
                
                const network = await provider.getNetwork();
                currentChainId = network.chainId;
                
                const mezoChainIdDecimal = parseInt(MEZO_TESTNET.chainId, 16);
                if (currentChainId !== mezoChainIdDecimal) {
                    document.getElementById('status').textContent = 'Connected to wrong network!';
                    document.getElementById('network').innerHTML = '<span class="network-badge network-wrong">‚ö†Ô∏è Wrong Network (Chain ID: ' + currentChainId + ')</span>';
                    document.getElementById('network').classList.remove('hidden');
                    document.getElementById('switchBtn').classList.remove('hidden');
                    return;
                }
                
                quiz = new ethers.Contract(QUIZ_ADDR, QUIZ_ABI, signer);
                nft = new ethers.Contract(NFT_ADDR, NFT_ABI, signer);
                musd = new ethers.Contract(MUSD_ADDR, MUSD_ABI, signer);
                
                await checkMUSDBalance();
                
                document.getElementById('status').textContent = '‚úÖ Connected!';
                document.getElementById('network').innerHTML = '<span class="network-badge network-correct">‚úì Mezo Testnet</span>';
                document.getElementById('network').classList.remove('hidden');
                document.getElementById('address').textContent = 'üìç Address: ' + userAddr.substring(0, 6) + '...' + userAddr.substring(38);
                document.getElementById('address').classList.remove('hidden');
                
                const balance = await provider.getBalance(userAddr);
                document.getElementById('balance').textContent = 'üí∞ Balance: ' + ethers.utils.formatEther(balance).substring(0, 8) + ' tBTC';
                document.getElementById('balance').classList.remove('hidden');
                
                document.getElementById('connectBtn').classList.add('hidden');
                document.getElementById('switchBtn').classList.add('hidden');
                
                // Show quiz card
                document.getElementById('quizCard').classList.remove('hidden');
                document.getElementById('nftCard').classList.remove('hidden');
                document.getElementById('leaderCard').classList.remove('hidden');
                document.getElementById('contractCard').classList.remove('hidden');
            } catch (err) {
                alert('Connection error: ' + err.message);
            }
        }

        async function checkMUSDBalance() {
            try {
                const balance = await musd.balanceOf(userAddr);
                const decimals = await musd.decimals();
                const balanceFormatted = ethers.utils.formatUnits(balance, decimals);
                musdBalance = parseFloat(balanceFormatted);
                
                if (musdBalance >= 1) {
                    document.getElementById('musdBoostSection').classList.remove('hidden');
                    document.getElementById('musdBalanceDisplay').textContent = 'üí∞ Your MUSD Balance: ' + musdBalance.toFixed(2) + ' MUSD';
                }
            } catch (err) {
                console.log('MUSD balance check failed:', err.message);
            }
        }

        function toggleBoost() {
            const toggle = document.getElementById('boostToggle');
            boostEnabled = toggle.checked;
            
            if (boostEnabled) {
                document.getElementById('boostActiveMsg').classList.remove('hidden');
            } else {
                document.getElementById('boostActiveMsg').classList.add('hidden');
            }
        }

        async function switchNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: MEZO_TESTNET.chainId }],
                });
                setTimeout(connect, 1000);
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [MEZO_TESTNET],
                        });
                        setTimeout(connect, 1000);
                    } catch (addError) {
                        alert('Failed to add Mezo testnet: ' + addError.message);
                    }
                } else {
                    alert('Failed to switch network: ' + switchError.message);
                }
            }
        }

        // Quiz Functions
        function generateQuestion() {
            const num1 = Math.floor(Math.random() * 10) + 1;
            const num2 = Math.floor(Math.random() * 10) + 1;
            const answer = num1 * num2;
            
            const options = [answer];
            while (options.length < 4) {
                const wrong = Math.floor(Math.random() * 100) + 1;
                if (!options.includes(wrong)) {
                    options.push(wrong);
                }
            }
            
            // Shuffle options
            for (let i = options.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [options[i], options[j]] = [options[j], options[i]];
            }
            
            return { num1, num2, answer, options };
        }

        function startQuiz() {
            // Reset state
            quizQuestions = [];
            currentQuestion = 0;
            correctAnswers = 0;
            wrongAnswers = 0;
            points = 0;
            timeLeft = 15;
            
            // Generate 5 questions
            for (let i = 0; i < 5; i++) {
                quizQuestions.push(generateQuestion());
            }
            
            // Update UI
            document.getElementById('quizStartScreen').classList.add('hidden');
            document.getElementById('quizGameScreen').classList.remove('hidden');
            
            showQuestion();
            startTimer();
        }

        function showQuestion() {
            const q = quizQuestions[currentQuestion];
            document.getElementById('question').textContent = q.num1 + ' √ó ' + q.num2 + ' = ?';
            
            const optionButtons = document.querySelectorAll('.quiz-option');
            q.options.forEach((opt, i) => {
                optionButtons[i].textContent = opt;
                optionButtons[i].className = 'quiz-option';
                optionButtons[i].disabled = false;
            });
            
            document.getElementById('currentQ').textContent = currentQuestion + 1;
            document.getElementById('progressBar').style.width = ((currentQuestion + 1) / 5 * 100) + '%';
            
            timeLeft = 15;
            document.getElementById('timer').textContent = timeLeft;
            document.getElementById('timer').classList.remove('warning');
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').textContent = timeLeft;
                
                if (timeLeft <= 5) {
                    document.getElementById('timer').classList.add('warning');
                }
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    selectAnswer(-1); // Time's up, wrong answer
                }
            }, 1000);
        }

        function selectAnswer(index) {
            clearInterval(timerInterval);
            
            const q = quizQuestions[currentQuestion];
            const selectedAnswer = index >= 0 ? q.options[index] : -1;
            const isCorrect = selectedAnswer === q.answer;
            
            // Update stats
            if (isCorrect) {
                correctAnswers++;
                points += 10;
            } else {
                wrongAnswers++;
                points = Math.max(0, points - 1);
            }
            
            // Show feedback
            const optionButtons = document.querySelectorAll('.quiz-option');
            optionButtons.forEach((btn, i) => {
                btn.disabled = true;
                if (q.options[i] === q.answer) {
                    btn.classList.add('correct');
                } else if (i === index) {
                    btn.classList.add('wrong');
                }
            });
            
            // Update display
            document.getElementById('correctCount').textContent = correctAnswers;
            document.getElementById('pointsCount').textContent = points;
            document.getElementById('wrongCount').textContent = wrongAnswers;
            
            // Next question or finish
            setTimeout(() => {
                currentQuestion++;
                if (currentQuestion < 5) {
                    showQuestion();
                    startTimer();
                } else {
                    finishQuiz();
                }
            }, 1500);
        }

        function finishQuiz() {
            clearInterval(timerInterval);
            
            document.getElementById('quizGameScreen').classList.add('hidden');
            document.getElementById('quizCompleteScreen').classList.remove('hidden');
            
            document.getElementById('finalCorrect').textContent = correctAnswers;
            document.getElementById('finalPoints').textContent = points;
            document.getElementById('finalWrong').textContent = wrongAnswers;
            
            // Show boost message if applicable
            if (boostEnabled && musdBalance >= 1) {
                const boostedPts = Math.floor(points * 1.5);
                document.getElementById('basePoints').textContent = points;
                document.getElementById('boostedPoints').textContent = boostedPts;
                document.getElementById('boostAppliedMsg').classList.remove('hidden');
            } else {
                document.getElementById('boostAppliedMsg').classList.add('hidden');
            }
        }

        function playAgain() {
            document.getElementById('quizCompleteScreen').classList.add('hidden');
            document.getElementById('quizStartScreen').classList.remove('hidden');
        }

        async function submitScore() {
            try {
                // Check if wallet is connected
                const walletCheck = checkWalletConnected('submit your score to the blockchain');
                if (!walletCheck.connected) {
                    document.getElementById('walletRequiredMsg').classList.remove('hidden');
                    show('quizResult', walletCheck.message, 'warning');
                    return;
                }
                
                let pts = points;
                
                if (pts === 0) {
                    show('quizResult', '‚ùå Cannot submit 0 points. Play again to earn points!', 'error');
                    return;
                }
                
                let originalPts = pts;
                if (boostEnabled && musdBalance >= 1) {
                    pts = Math.floor(pts * 1.5);
                    show('quizResult', '‚ö° MUSD Boost Applied!\n\nOriginal: ' + originalPts + ' points\nBoosted: ' + pts + ' points\n\nSubmitting to blockchain...');
                } else {
                    show('quizResult', '‚è≥ Submitting ' + pts + ' points to blockchain...');
                }
                
                document.getElementById('submitScoreBtn').disabled = true;
                
                const tx = await quiz.updateScore(userAddr, pts);
                show('quizResult', '‚è≥ Transaction sent! Hash: ' + tx.hash + '\n\nWaiting for confirmation...');
                await tx.wait();
                
                let resultMsg = '‚úÖ Score submitted successfully!\n\nTransaction: ' + tx.hash + '\nPoints recorded: ' + pts;
                if (boostEnabled && musdBalance >= 1) {
                    resultMsg += '\n\n‚ö° MUSD Boost: ' + originalPts + ' ‚Üí ' + pts + ' points';
                }
                resultMsg += '\n\nView: https://explorer.test.mezo.org/tx/' + tx.hash;
                
                show('quizResult', resultMsg, 'success');
                
                // Reset boost
                if (boostEnabled) {
                    document.getElementById('boostToggle').checked = false;
                    boostEnabled = false;
                    document.getElementById('boostActiveMsg').classList.add('hidden');
                }
            } catch (err) {
                show('quizResult', '‚ùå Error: ' + err.message, 'error');
                document.getElementById('submitScoreBtn').disabled = false;
            }
        }

        async function getScore() {
            try {
                const walletCheck = checkWalletConnected('view your total score');
                if (!walletCheck.connected) {
                    show('scoreResult', walletCheck.message, 'warning');
                    return;
                }
                show('scoreResult', '‚è≥ Fetching your total score...');
                const score = await quiz.getScore(userAddr);
                show('scoreResult', '‚úÖ Your Total Score: ' + score.toString() + ' points\n\n' + (score >= 50 ? 'üéâ Eligible to mint NFT!' : '‚ö†Ô∏è Need ' + (50 - score) + ' more points'), score >= 50 ? 'success' : 'warning');
            } catch (err) {
                show('scoreResult', '‚ùå Error: ' + err.message, 'error');
            }
        }

        async function checkEligible() {
            try {
                const walletCheck = checkWalletConnected('check NFT eligibility');
                if (!walletCheck.connected) {
                    show('scoreResult', walletCheck.message, 'warning');
                    return;
                }
                show('scoreResult', '‚è≥ Checking eligibility...');
                const can = await quiz.canMintNFT(userAddr);
                const score = await quiz.getScore(userAddr);
                if (can) {
                    show('scoreResult', '‚úÖ Eligible!\n\nScore: ' + score + ' points\nüéâ You can mint your NFT!', 'success');
                } else {
                    show('scoreResult', '‚ö†Ô∏è Not eligible\n\nScore: ' + score + '\nNeed: 50 points', 'warning');
                }
            } catch (err) {
                show('scoreResult', '‚ùå Error: ' + err.message, 'error');
            }
        }

        async function mintNFT() {
            try {
                const walletCheck = checkWalletConnected('mint your NFT badge');
                if (!walletCheck.connected) {
                    show('nftResult', walletCheck.message, 'warning');
                    return;
                }
                const uri = document.getElementById('tokenUri').value;
                show('nftResult', '‚è≥ Minting NFT...');
                const tx = await nft.mintBadge(uri);
                show('nftResult', '‚è≥ Tx: ' + tx.hash + '\n\nWaiting...');
                await tx.wait();
                show('nftResult', '‚úÖ NFT Minted! üéâ\n\nTx: ' + tx.hash + '\n\nCheck MetaMask NFTs tab!', 'success');
            } catch (err) {
                let msg = err.message;
                if (msg.includes('already minted')) msg = 'Already minted! One per wallet.';
                if (msg.includes('Insufficient')) msg = 'Need 50+ points first!';
                show('nftResult', '‚ùå ' + msg, 'error');
            }
        }

        async function checkMintStatus() {
            try {
                const walletCheck = checkWalletConnected('check your mint status');
                if (!walletCheck.connected) {
                    show('nftResult', walletCheck.message, 'warning');
                    return;
                }
                show('nftResult', '‚è≥ Checking...');
                const minted = await nft.hasUserMinted(userAddr);
                if (minted) {
                    const id = await nft.getUserTokenId(userAddr);
                    show('nftResult', '‚úÖ You have minted!\n\nToken ID: ' + id, 'success');
                } else {
                    show('nftResult', '‚ÑπÔ∏è Not minted yet\n\nEarn 50+ points first', 'warning');
                }
            } catch (err) {
                show('nftResult', '‚ùå Error: ' + err.message, 'error');
            }
        }

        async function getLeaderboard() {
            try {
                // Leaderboard can be viewed without wallet, but show better message if not connected
                if (!quiz) {
                    // Create read-only provider to view leaderboard without wallet
                    try {
                        const readProvider = new ethers.providers.JsonRpcProvider(MEZO_TESTNET.rpcUrls[0]);
                        const readQuiz = new ethers.Contract(QUIZ_ADDR, QUIZ_ABI, readProvider);
                        
                        show('leaderResult', '‚è≥ Loading leaderboard...');
                        const result = await readQuiz.getLeaderboard();
                        const addrs = result[0];
                        const scores = result[1];
                        
                        if (addrs.length === 0) {
                            show('leaderResult', 'No players yet! üöÄ\n\nBe the first to play and submit a score!', 'warning');
                            return;
                        }
                        
                        let html = '<div style="color: white;"><strong>üèÜ Top Players</strong><br><br>';
                        html += '<div style="background: rgba(251,191,36,0.2); padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 12px;">';
                        html += '‚ÑπÔ∏è Connect wallet to see if you\'re on the leaderboard';
                        html += '</div>';
                        for (let i = 0; i < addrs.length; i++) {
                            const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : (i + 1) + '.';
                            const short = addrs[i].substring(0, 6) + '...' + addrs[i].substring(38);
                            html += '<div style="padding: 8px; margin: 5px 0; background: rgba(255,255,255,0.1); border-radius: 5px;">';
                            html += '<span style="display: inline-block; width: 30px;">' + medal + '</span>';
                            html += '<span>' + short + '</span>';
                            html += '<span style="float: right; font-weight: bold;">' + scores[i] + ' pts</span>';
                            html += '</div>';
                        }
                        html += '</div>';
                        document.getElementById('leaderResult').innerHTML = html;
                        document.getElementById('leaderResult').classList.remove('hidden');
                        return;
                    } catch (readErr) {
                        show('leaderResult', '‚ö†Ô∏è Unable to load leaderboard\n\n' + readErr.message + '\n\nTip: Connect your wallet for better experience', 'warning');
                        return;
                    }
                }
                
                show('leaderResult', '‚è≥ Loading...');
                const result = await quiz.getLeaderboard();
                const addrs = result[0];
                const scores = result[1];
                
                if (addrs.length === 0) {
                    show('leaderResult', 'No players yet! üöÄ', 'warning');
                    return;
                }
                
                let html = '<div style="color: white;"><strong>üèÜ Top Players</strong><br><br>';
                for (let i = 0; i < addrs.length; i++) {
                    const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : (i + 1) + '.';
                    const short = addrs[i].substring(0, 6) + '...' + addrs[i].substring(38);
                    const isYou = userAddr && addrs[i].toLowerCase() === userAddr.toLowerCase() ? ' (YOU)' : '';
                    html += '<div style="padding: 8px; margin: 5px 0; background: rgba(255,255,255,0.1); border-radius: 5px;">';
                    html += '<span style="display: inline-block; width: 30px;">' + medal + '</span>';
                    html += '<span>' + short + isYou + '</span>';
                    html += '<span style="float: right; font-weight: bold;">' + scores[i] + ' pts</span>';
                    html += '</div>';
                }
                html += '</div>';
                document.getElementById('leaderResult').innerHTML = html;
                document.getElementById('leaderResult').classList.remove('hidden');
            } catch (err) {
                show('leaderResult', '‚ùå Error: ' + err.message, 'error');
            }
        }

        function show(id, msg, cls) {
            const el = document.getElementById(id);
            el.textContent = msg;
            el.className = 'result';
            if (cls) el.classList.add(cls);
            el.classList.remove('hidden');
        }

        function checkWalletConnected(actionName) {
            if (!userAddr || !quiz) {
                return {
                    connected: false,
                    message: '‚ö†Ô∏è Wallet Required\n\n' + 
                             'To ' + actionName + ', please connect your MetaMask wallet first.\n\n' +
                             'üëÜ Scroll up to the "Wallet Connection" section and click "Connect MetaMask"'
                };
            }
            return { connected: true };
        }

        if (window.ethereum) {
            window.ethereum.on('accountsChanged', () => location.reload());
            window.ethereum.on('chainChanged', () => location.reload());
        }
    </script>
</body>
</html>
