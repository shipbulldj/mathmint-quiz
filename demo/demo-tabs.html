<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MathMint Quiz - Tabbed Interface</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1100px; margin: 0 auto; }
        
        /* Header */
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 3em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.2em; opacity: 0.9; }
        
        /* Tabs */
        .tabs { display: flex; gap: 15px; margin-bottom: 30px; border-bottom: 3px solid rgba(255,255,255,0.2); }
        .tab { 
            padding: 15px 40px; 
            font-size: 1.3em; 
            font-weight: 600; 
            background: rgba(255,255,255,0.1); 
            border: none; 
            color: rgba(255,255,255,0.6); 
            cursor: pointer; 
            border-radius: 10px 10px 0 0;
            transition: all 0.3s;
            position: relative;
            top: 3px;
        }
        .tab:hover { background: rgba(255,255,255,0.15); color: rgba(255,255,255,0.8); }
        .tab.active { 
            background: rgba(255,255,255,0.25); 
            color: white; 
            border-bottom: 3px solid #4facfe;
        }
        
        /* Tab Content */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Cards */
        .card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .card h2 { font-size: 1.8em; margin-bottom: 15px; border-bottom: 2px solid rgba(255,255,255,0.2); padding-bottom: 10px; }
        .card h3 { font-size: 1.3em; margin: 15px 0 10px 0; }
        
        /* Buttons */
        button {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            margin: 8px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        button.success { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        button.warning { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
        button.large { padding: 20px 50px; font-size: 1.3em; }
        
        /* Quiz Styles */
        .quiz-box { background: rgba(0,0,0,0.2); border-radius: 15px; padding: 30px; margin: 20px 0; text-align: center; }
        .question { font-size: 3.5em; font-weight: bold; margin: 30px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .options { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0; }
        .option {
            padding: 25px;
            font-size: 2em;
            font-weight: bold;
            background: rgba(255,255,255,0.25);
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .option:hover { background: rgba(255,255,255,0.35); transform: scale(1.05); }
        .option.correct { background: rgba(16,185,129,0.6); border-color: #10b981; animation: correctPulse 0.5s; }
        .option.wrong { background: rgba(239,68,68,0.6); border-color: #ef4444; animation: shake 0.5s; }
        
        @keyframes correctPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        
        .timer { font-size: 2.5em; font-weight: bold; margin: 20px 0; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px; display: inline-block; }
        .timer.warning { color: #fbbf24; animation: pulse 1s infinite; }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .progress-bar { height: 15px; background: rgba(0,0,0,0.3); border-radius: 10px; overflow: hidden; margin: 20px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4facfe, #00f2fe); transition: width 0.3s; border-radius: 10px; }
        
        .stats { display: flex; justify-content: space-around; margin: 30px 0; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 15px; }
        .stat { text-align: center; }
        .stat-value { font-size: 2.5em; font-weight: bold; display: block; }
        .stat-label { font-size: 1em; opacity: 0.8; margin-top: 5px; }
        
        /* Bank Info Grid */
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0; }
        .info-item {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #4facfe;
        }
        .info-item h4 { font-size: 0.9em; opacity: 0.8; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .info-value { font-size: 2em; font-weight: bold; color: #4facfe; }
        .info-sub { font-size: 0.85em; opacity: 0.7; margin-top: 5px; }
        
        /* Boost Hint */
        .boost-hint {
            background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,170,0,0.2));
            border: 2px solid rgba(255,215,0,0.5);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .boost-hint.active { background: linear-gradient(135deg, rgba(255,215,0,0.4), rgba(255,170,0,0.4)); }
        
        /* Leaderboard */
        .leaderboard { margin: 20px 0; }
        .leader-item {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            margin: 8px 0;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }
        .leader-item:hover { background: rgba(0,0,0,0.3); }
        .leader-item.me { background: rgba(74,172,254,0.3); border-left: 4px solid #4facfe; }
        .leader-rank { font-size: 1.5em; font-weight: bold; min-width: 40px; }
        .leader-address { flex: 1; font-family: monospace; }
        .leader-score { font-size: 1.3em; font-weight: bold; color: #fbbf24; }
        
        /* Messages */
        .message {
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 4px solid;
        }
        .message.success { background: rgba(16,185,129,0.2); border-color: #10b981; }
        .message.error { background: rgba(239,68,68,0.2); border-color: #ef4444; }
        .message.warning { background: rgba(251,191,36,0.2); border-color: #fbbf24; }
        .message.info { background: rgba(74,172,254,0.2); border-color: #4facfe; }
        
        .hidden { display: none; }
        
        /* Loading */
        .loading { text-align: center; padding: 20px; opacity: 0.7; }
        .spinner { display: inline-block; width: 30px; height: 30px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Toggle Switch */
        .toggle { position: relative; display: inline-block; width: 60px; height: 30px; margin: 0 10px; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.3);
            transition: 0.4s;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px; width: 22px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(30px); }
        
        @media (max-width: 768px) {
            .options { grid-template-columns: 1fr; }
            .header h1 { font-size: 2em; }
            .question { font-size: 2.5em; }
            .tab { padding: 12px 20px; font-size: 1.1em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üéÆ MathMint Quiz</h1>
            <p>Learn Times Tables, Mint Badges & Own A Bank <span style="text-decoration: line-through; color: #ef4444;">Account</span> On Mezo</p>
        </div>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('quiz')">üìä Quiz</button>
            <button class="tab" onclick="switchTab('bank')">üè¶ Bank</button>
        </div>
        
        <!-- QUIZ TAB -->
        <div id="quizTab" class="tab-content active">
            
            <!-- MUSD Boost Hint - Always Visible -->
            <div id="boostHintNoMUSD" class="boost-hint">
                <span style="font-size: 2em;">‚ö°</span>
                <div style="flex: 1;">
                    <strong style="font-size: 1.2em;">Want 1.5x BEAST MODE Points?</strong><br>
                    <span style="font-size: 0.95em; opacity: 0.9;">Get MUSD tokens for a super boost! Each correct answer becomes 15 points instead of 10! üî•</span>
                </div>
                <a href="https://testnet.mezo.org/" target="_blank" style="padding: 12px 24px; background: linear-gradient(135deg, #fbbf24, #f59e0b); color: white; text-decoration: none; border-radius: 10px; font-weight: bold; white-space: nowrap; box-shadow: 0 4px 12px rgba(251,191,36,0.3);">
                    üåü Swap for MUSD
                </a>
            </div>
            
            <!-- MUSD Boost Enabled -->
            <div id="boostHintWithMUSD" class="boost-hint active hidden">
                <span style="font-size: 2em;">‚ö°</span>
                <div style="flex: 1;">
                    <strong style="font-size: 1.2em;">‚ö° SECRET POWER-UP UNLOCKED!</strong><br>
                    <span id="musdBalanceDisplay" style="font-size: 0.95em; opacity: 0.95;">You've got MUSD! Turn ON the boost before playing for 1.5x points! üî•</span>
                </div>
                <label class="toggle">
                    <input type="checkbox" id="boostToggle" onchange="toggleBoost()">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div id="boostActiveMsg" class="message success hidden" style="margin-top: 15px;">
                ‚úÖ <strong>Boost Active!</strong> Earning 15 points per correct answer this session! üöÄ
            </div>
            
            <!-- Quiz Card -->
            <div class="card">
                <h2>üéØ Times Tables Challenge</h2>
                
                <!-- Quiz Start -->
                <div id="quizStart" class="quiz-box">
                    <p style="font-size: 1.4em; margin: 20px 0; font-weight: 600;">üéâ Ready to Test Your Times Tables?</p>
                    <p style="font-size: 1.1em; margin: 15px 0;">No wallet needed! Just click and play!</p>
                    <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 12px; margin: 25px 0; text-align: left;">
                        <div style="margin: 10px 0; font-size: 1.05em;">‚úÖ Get <strong>10 points</strong> for each correct answer</div>
                        <div style="margin: 10px 0; font-size: 1.05em;">‚ùå Lose <strong>1 point</strong> for wrong answers</div>
                        <div style="margin: 10px 0; font-size: 1.05em;">‚è±Ô∏è You have <strong>15 seconds</strong> per question</div>
                        <div style="margin: 10px 0; font-size: 1.05em;">‚ö° <strong>Pro Tip:</strong> Enable MUSD boost above for 1.5x points!</div>
                    </div>
                    <button class="large success" onclick="startQuiz()">üöÄ Start Quiz!</button>
                </div>
                
                <!-- Quiz Play -->
                <div id="quizPlay" class="quiz-box hidden">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 20%"></div>
                    </div>
                    <div class="timer" id="timer">15</div>
                    <div class="question" id="question">? √ó ? = ?</div>
                    <div class="options" id="options"></div>
                    <div id="feedback" class="hidden" style="font-size: 1.5em; margin: 20px 0;"></div>
                </div>
                
                <!-- Quiz Results -->
                <div id="quizResults" class="hidden">
                    <h2 style="font-size: 2.5em; text-align: center; margin: 20px 0;">üéâ Quiz Complete!</h2>
                    
                    <div class="stats">
                        <div class="stat">
                            <span class="stat-value" id="correctCount">0</span>
                            <span class="stat-label">‚úÖ Correct</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value" id="pointsEarned">0</span>
                            <span class="stat-label">‚≠ê Points</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value" id="wrongCount">0</span>
                            <span class="stat-label">‚ùå Wrong</span>
                        </div>
                    </div>
                    
                    <div id="boostAppliedMessage" class="message warning hidden" style="margin: 20px 0;">
                        <strong>‚ö° MUSD Boost Applied!</strong><br>
                        Your points were boosted by 1.5x because you had the boost enabled! üî•
                    </div>
                    
                    <div id="walletRequiredMsg" class="message info hidden" style="margin: 20px 0;">
                        <strong>üíæ Want to Keep These Points Forever?</strong><br>
                        Connect your bank in the "Bank" tab! Don't have one yet? We'll guide you through creating it - super easy! üè¶‚ú®
                    </div>
                    
                    <div style="text-align: center; margin: 25px 0;">
                        <button class="success large" onclick="saveScore()">üíæ Save Points to My Bank!</button>
                        <button onclick="playAgain()">üîÑ Play Again</button>
                    </div>
                    
                    <div id="saveMessage" class="message hidden"></div>
                </div>
            </div>
            
            <!-- Leaderboard Card -->
            <div class="card">
                <h2>üèÜ Top Champions</h2>
                <div id="leaderboardContent" class="loading">
                    <div class="spinner"></div>
                    <p>Loading leaderboard...</p>
                </div>
            </div>
        </div>
        
        <!-- BANK TAB -->
        <div id="bankTab" class="tab-content">
            
            <!-- Not Connected State -->
            <div id="notConnected" class="card">
                <h2>üè¶ Welcome to Your Bank of Good Times!</h2>
                <p style="font-size: 1.2em; margin: 20px 0; line-height: 1.6;">
                    Ready to save your quiz points forever and own digital badges? <br>
                    Connect or create your own bank on the blockchain! üöÄ
                </p>
                
                <div style="background: rgba(255,215,0,0.15); padding: 20px; border-radius: 12px; border: 2px solid rgba(255,215,0,0.3); margin: 25px 0;">
                    <h3 style="margin: 0 0 15px 0; font-size: 1.3em;">‚ú® Why Your Own Bank?</h3>
                    <ul style="line-height: 2; margin-left: 20px; font-size: 1.05em;">
                        <li><strong>YOU are in control</strong> - No middleman needed!</li>
                        <li><strong>Save points forever</strong> - Stored on the blockchain</li>
                        <li><strong>Mint cool badges</strong> - Digital collectibles (NFTs)</li>
                        <li><strong>It's free practice</strong> - This is testnet, zero risk!</li>
                    </ul>
                </div>
                
                <div style="display: flex; gap: 15px; margin: 30px 0; flex-wrap: wrap; justify-content: center;">
                    <button class="success large" onclick="showWelcomeModal()">üè¶ Connect to My Bank</button>
                    <button class="large" style="background: linear-gradient(135deg, #fbbf24, #f59e0b);" onclick="showCreateBankGuide()">‚ú® Create My First Bank</button>
                </div>
                
                <div class="message info">
                    <strong>üí° New to Web3?</strong><br>
                    Don't worry! Creating your bank means installing MetaMask (a free digital wallet). We'll guide you step-by-step - it takes just 2 minutes! Think of it like installing any other browser extension.<br><br>
                    <strong>üéÅ Need test funds?</strong> Get free tBTC here: <a href="https://faucet.test.mezo.org" target="_blank" style="color: #4facfe; font-weight: bold; text-decoration: underline;">faucet.test.mezo.org</a>
                </div>
            </div>
            
            <!-- Connected State -->
            <div id="connected" class="hidden">
                
                <!-- Wallet Overview -->
                <div class="card">
                    <h2>üíº Wallet Overview</h2>
                    <div id="walletAddress" style="font-family: monospace; font-size: 1.1em; margin: 10px 0; opacity: 0.8;"></div>
                    
                    <div class="info-grid">
                        <div class="info-item">
                            <h4>üí∞ tBTC Balance</h4>
                            <div class="info-value" id="tbtcBalance">-</div>
                            <div class="info-sub">Testnet Bitcoin</div>
                        </div>
                        <div class="info-item">
                            <h4>‚ö° MUSD Balance</h4>
                            <div class="info-value" id="musdBalance">-</div>
                            <div class="info-sub">
                                <span id="musdStatus">Loading...</span><br>
                                <a href="https://testnet.mezo.org/" target="_blank" style="color: #ffd700; font-weight: bold;">Swap for MUSD</a>
                            </div>
                        </div>
                        <div class="info-item">
                            <h4>üéØ Quiz Points (Saved)</h4>
                            <div class="info-value" id="savedPoints">-</div>
                            <div class="info-sub">On blockchain</div>
                        </div>
                        <div class="info-item" id="pendingPointsItem" class="hidden">
                            <h4>‚è≥ Pending Points</h4>
                            <div class="info-value" id="pendingPoints">0</div>
                            <div class="info-sub">Not yet saved</div>
                        </div>
                    </div>
                </div>
                
                <!-- NFT Badge -->
                <div class="card">
                    <h2>üé® Achievement Badge</h2>
                    <div id="nftContent" class="loading">
                        <div class="spinner"></div>
                        <p>Checking NFT status...</p>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
    
    <!-- Modals (same as before) -->
    <div id="welcomeModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 1000;">
        <div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 40px; border-radius: 20px; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <h2 style="text-align: center; margin-bottom: 20px;">üè¶ Welcome to Your Bank of Good Times!</h2>
            <p style="text-align: center; font-size: 1.2em; margin-bottom: 20px;">üéâ You're about to become your own bank!</p>
            <div style="background: rgba(255,255,255,0.1); padding: 15px; margin: 15px 0; border-radius: 10px;">
                <h3>üîë Quick Security Tips:</h3>
                <ul style="line-height: 2; margin-left: 20px;">
                    <li>Never share your seed phrase</li>
                    <li>Write it on paper, not phone</li>
                    <li>This is testnet - safe to learn!</li>
                    <li>You're in control of everything</li>
                </ul>
            </div>
            <div style="margin: 20px 0; padding: 15px; background: rgba(255,215,0,0.1); border-radius: 10px;">
                <input type="checkbox" id="understandCheck" style="width: 20px; height: 20px; margin-right: 10px;">
                <label for="understandCheck" style="font-size: 1.1em;">I understand!</label>
            </div>
            <div style="display: flex; gap: 15px;">
                <button onclick="closeWelcomeModal()" style="flex: 1; background: rgba(255,255,255,0.2);">Maybe Later</button>
                <button id="continueBtn" onclick="proceedFromModal()" disabled style="flex: 1;">Let's Go! üöÄ</button>
            </div>
        </div>
    </div>
    
    <div id="createBankModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 1000;">
        <div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 40px; border-radius: 20px; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <h2 style="text-align: center; margin-bottom: 20px;">üåü Let's Create Your First Bank!</h2>
            <div style="background: rgba(255,255,255,0.1); padding: 20px; margin: 15px 0; border-radius: 10px;">
                <h3>1. Install MetaMask</h3>
                <p>Go to <a href="https://metamask.io" target="_blank" style="color: #4facfe;">metamask.io</a> and install</p>
            </div>
            <div style="background: rgba(255,255,255,0.1); padding: 20px; margin: 15px 0; border-radius: 10px;">
                <h3>2. Write Down Your Seed Phrase</h3>
                <p>üìù Write these words on PAPER (super important!)</p>
            </div>
            <div style="background: rgba(255,255,255,0.1); padding: 20px; margin: 15px 0; border-radius: 10px;">
                <h3>3. Come Back Here!</h3>
                <p>Click "Connect My Bank" once MetaMask is installed</p>
            </div>
            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button onclick="closeCreateBankModal()" style="flex: 1; background: rgba(255,255,255,0.2);">Close</button>
                <button onclick="openMetaMaskSite()" class="success" style="flex: 1;">Take Me to MetaMask! ü¶ä</button>
            </div>
        </div>
    </div>

    <script>
        // Contract Configuration
        const MEZO_TESTNET = {
            chainId: '0x7b7b',
            chainName: 'Mezo Testnet',
            rpcUrls: ['https://rpc.test.mezo.org'],
            nativeCurrency: { name: 'tBTC', symbol: 'tBTC', decimals: 18 },
            blockExplorerUrls: ['https://explorer.test.mezo.org']
        };
        
        const QUIZ_ADDR = '0x59bDB59107f29e9712A37c7015ee28675DD7d30f';
        const NFT_ADDR = '0x03672f6b20622176554a4C0ba7B037d9dCE531f0';
        const MUSD_ADDR = '0x118917a40FAF1CD7a13dB0Ef56C86De7973Ac503';
        
        const QUIZ_ABI = [
            "function updateScore(address user, uint256 points)",
            "function getScore(address user) view returns (uint256)",
            "function canMintNFT(address user) view returns (bool)",
            "function getLeaderboard() view returns (address[], uint256[])"
        ];
        
        const NFT_ABI = [
            "function mint(string memory tokenURI)",
            "function hasMinted(address player) view returns (bool)",
            "function balanceOf(address owner) view returns (uint256)"
        ];
        
        const MUSD_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function decimals() view returns (uint8)"
        ];
        
        // State
        let provider, signer, quiz, nft, musd, userAddr;
        let quizQuestions = [];
        let currentQuestion = 0;
        let correctAnswers = 0;
        let wrongAnswers = 0;
        let points = 0;
        let timerInterval;
        let timeLeft = 15;
        let boostEnabled = false;
        let musdBalance = 0;
        
        // Tab Management
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            if (tabName === 'bank' && userAddr) {
                refreshBankData();
            } else if (tabName === 'quiz') {
                loadLeaderboard();
            }
        }
        
        // Initialize
        window.addEventListener('load', () => {
            loadLeaderboard();
            checkWalletConnection();
        });
        
        async function checkWalletConnection() {
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        await connect();
                    }
                } catch (err) {
                    console.log('Not connected');
                }
            }
        }
        
        // Modal Functions
        function showWelcomeModal() {
            const hasSeenWelcome = localStorage.getItem('mathMintWelcomeSeen');
            if (!hasSeenWelcome) {
                const modal = document.getElementById('welcomeModal');
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
                document.getElementById('understandCheck').addEventListener('change', function() {
                    document.getElementById('continueBtn').disabled = !this.checked;
                });
            } else {
                connect();
            }
        }
        
        function closeWelcomeModal() {
            const modal = document.getElementById('welcomeModal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
        }
        
        function proceedFromModal() {
            localStorage.setItem('mathMintWelcomeSeen', 'true');
            closeWelcomeModal();
            connect();
        }
        
        function showCreateBankGuide() {
            const modal = document.getElementById('createBankModal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }
        
        function closeCreateBankModal() {
            const modal = document.getElementById('createBankModal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
        }
        
        function openMetaMaskSite() {
            window.open('https://metamask.io', '_blank');
        }
        
        // Wallet Connection
        async function connect() {
            try {
                if (!window.ethereum) {
                    alert('Please install MetaMask!');
                    return;
                }
                
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddr = await signer.getAddress();
                
                const network = await provider.getNetwork();
                const chainId = '0x' + network.chainId.toString(16);
                
                if (chainId !== MEZO_TESTNET.chainId) {
                    await switchNetwork();
                    return;
                }
                
                quiz = new ethers.Contract(QUIZ_ADDR, QUIZ_ABI, signer);
                nft = new ethers.Contract(NFT_ADDR, NFT_ABI, signer);
                musd = new ethers.Contract(MUSD_ADDR, MUSD_ABI, provider);
                
                document.getElementById('notConnected').classList.add('hidden');
                document.getElementById('connected').classList.remove('hidden');
                document.getElementById('boostHint').classList.remove('hidden');
                
                await refreshBankData();
                
            } catch (err) {
                console.error('Connection error:', err);
                alert('Connection failed: ' + err.message);
            }
        }
        
        async function switchNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [MEZO_TESTNET]
                });
                location.reload();
            } catch (err) {
                alert('Failed to switch network: ' + err.message);
            }
        }
        
        // Refresh Bank Data
        async function refreshBankData() {
            document.getElementById('walletAddress').textContent = 'üìç ' + userAddr.substring(0, 8) + '...' + userAddr.substring(38);
            
            // Get tBTC balance
            try {
                const balance = await provider.getBalance(userAddr);
                const tbtc = parseFloat(ethers.utils.formatEther(balance)).toFixed(4);
                document.getElementById('tbtcBalance').textContent = tbtc;
            } catch (err) {
                console.error('tBTC balance error:', err);
                document.getElementById('tbtcBalance').textContent = 'Error';
            }
            
            // Get MUSD balance and update boost hints
            try {
                const balance = await musd.balanceOf(userAddr);
                const decimals = await musd.decimals();
                musdBalance = parseFloat(ethers.utils.formatUnits(balance, decimals));
                document.getElementById('musdBalance').textContent = musdBalance.toFixed(2);
                
                if (musdBalance >= 1) {
                    // User has MUSD - show the toggle
                    document.getElementById('musdStatus').textContent = '‚úÖ Boost available!';
                    document.getElementById('boostHintNoMUSD').classList.add('hidden');
                    document.getElementById('boostHintWithMUSD').classList.remove('hidden');
                    document.getElementById('musdBalanceDisplay').textContent = `You have ${musdBalance.toFixed(2)} MUSD! Turn ON the boost before playing for 1.5x points! üî•`;
                } else {
                    // User doesn't have MUSD - show the swap prompt
                    document.getElementById('musdStatus').textContent = 'Need 1+ MUSD for boost';
                    document.getElementById('boostHintNoMUSD').classList.remove('hidden');
                    document.getElementById('boostHintWithMUSD').classList.add('hidden');
                }
            } catch (err) {
                console.error('MUSD balance error:', err);
                document.getElementById('musdBalance').textContent = 'Error';
                document.getElementById('musdStatus').textContent = 'Error loading';
            }
            
            // Get saved quiz points
            try {
                const score = await quiz.getScore(userAddr);
                document.getElementById('savedPoints').textContent = score.toString();
            } catch (err) {
                console.error('Quiz score error:', err);
                document.getElementById('savedPoints').textContent = 'Error';
            }
            
            // Check NFT status
            checkNFTStatus();
        }
        
        async function checkNFTStatus() {
            const content = document.getElementById('nftContent');
            try {
                const hasMinted = await nft.hasMinted(userAddr);
                const canMint = await quiz.canMintNFT(userAddr);
                const savedScore = await quiz.getScore(userAddr);
                
                if (hasMinted) {
                    const balance = await nft.balanceOf(userAddr);
                    content.innerHTML = `
                        <div class="message success">
                            <strong>üéâ You own ${balance} MathMint Badge${balance > 1 ? 's' : ''}!</strong><br>
                            Check your MetaMask NFTs tab to view it!
                        </div>
                    `;
                } else if (canMint) {
                    content.innerHTML = `
                        <div class="message success">
                            <strong>‚úÖ Eligible to Mint!</strong><br>
                            You have ${savedScore} points (need 50+)
                        </div>
                        <button class="success large" onclick="mintBadge()">üé® Mint My Badge!</button>
                    `;
                } else {
                    const needed = 50 - parseInt(savedScore);
                    content.innerHTML = `
                        <div class="message info">
                            <strong>Keep Playing! üéØ</strong><br>
                            You have ${savedScore} points. Need ${needed} more points to mint your badge!
                        </div>
                    `;
                }
            } catch (err) {
                content.innerHTML = `<div class="message error">Error checking NFT status: ${err.message}</div>`;
            }
        }
        
        async function mintBadge() {
            const content = document.getElementById('nftContent');
            try {
                content.innerHTML = '<div class="loading"><div class="spinner"></div><p>Minting your badge...</p></div>';
                const tx = await nft.mint('ipfs://QmMathMintBadge/metadata.json');
                await tx.wait();
                content.innerHTML = '<div class="message success"><strong>üéâ Badge Minted!</strong><br>Check MetaMask NFTs tab!</div>';
                setTimeout(checkNFTStatus, 2000);
            } catch (err) {
                content.innerHTML = `<div class="message error">Minting failed: ${err.message}</div>`;
                setTimeout(checkNFTStatus, 3000);
            }
        }
        
        // Load Leaderboard
        async function loadLeaderboard() {
            const content = document.getElementById('leaderboardContent');
            try {
                const readProvider = new ethers.providers.JsonRpcProvider(MEZO_TESTNET.rpcUrls[0]);
                const readQuiz = new ethers.Contract(QUIZ_ADDR, QUIZ_ABI, readProvider);
                
                const result = await readQuiz.getLeaderboard();
                const addrs = result[0];
                const scores = result[1];
                
                if (addrs.length === 0) {
                    content.innerHTML = '<div class="message info">No players yet! Be the first! üöÄ</div>';
                    return;
                }
                
                let html = '<div class="leaderboard">';
                for (let i = 0; i < addrs.length; i++) {
                    const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : (i + 1) + '.';
                    const short = addrs[i].substring(0, 6) + '...' + addrs[i].substring(38);
                    const isMe = userAddr && addrs[i].toLowerCase() === userAddr.toLowerCase();
                    html += `
                        <div class="leader-item ${isMe ? 'me' : ''}">
                            <span class="leader-rank">${medal}</span>
                            <span class="leader-address">${short} ${isMe ? '(YOU!)' : ''}</span>
                            <span class="leader-score">${scores[i]} pts</span>
                        </div>
                    `;
                }
                html += '</div>';
                content.innerHTML = html;
            } catch (err) {
                content.innerHTML = `<div class="message error">Failed to load: ${err.message}</div>`;
            }
        }
        
        // MUSD Boost
        function toggleBoost() {
            boostEnabled = document.getElementById('boostToggle').checked;
            if (boostEnabled && musdBalance < 1) {
                document.getElementById('boostToggle').checked = false;
                boostEnabled = false;
                alert('You need 1+ MUSD to enable boost!');
            }
        }
        
        // Quiz Logic
        function generateQuestions() {
            quizQuestions = [];
            for (let i = 0; i < 5; i++) {
                const a = Math.floor(Math.random() * 10) + 1;
                const b = Math.floor(Math.random() * 10) + 1;
                const correct = a * b;
                const options = [correct];
                while (options.length < 4) {
                    const wrong = Math.floor(Math.random() * 100) + 1;
                    if (!options.includes(wrong)) options.push(wrong);
                }
                options.sort(() => Math.random() - 0.5);
                quizQuestions.push({ a, b, correct, options });
            }
        }
        
        function startQuiz() {
            generateQuestions();
            currentQuestion = 0;
            correctAnswers = 0;
            wrongAnswers = 0;
            points = 0;
            
            document.getElementById('quizStart').classList.add('hidden');
            document.getElementById('quizResults').classList.add('hidden');
            document.getElementById('quizPlay').classList.remove('hidden');
            
            showQuestion();
        }
        
        function showQuestion() {
            const q = quizQuestions[currentQuestion];
            document.getElementById('question').textContent = `${q.a} √ó ${q.b} = ?`;
            
            const optionsDiv = document.getElementById('options');
            optionsDiv.innerHTML = '';
            q.options.forEach(opt => {
                const btn = document.createElement('div');
                btn.className = 'option';
                btn.textContent = opt;
                btn.onclick = () => checkAnswer(opt);
                optionsDiv.appendChild(btn);
            });
            
            const progress = ((currentQuestion + 1) / 5) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            startTimer();
        }
        
        function startTimer() {
            timeLeft = 15;
            document.getElementById('timer').textContent = timeLeft;
            document.getElementById('timer').classList.remove('warning');
            
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').textContent = timeLeft;
                
                if (timeLeft <= 5) {
                    document.getElementById('timer').classList.add('warning');
                }
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    checkAnswer(null);
                }
            }, 1000);
        }
        
        function checkAnswer(answer) {
            clearInterval(timerInterval);
            
            const q = quizQuestions[currentQuestion];
            const correct = answer === q.correct;
            
            const options = document.querySelectorAll('.option');
            options.forEach(opt => {
                opt.onclick = null;
                if (parseInt(opt.textContent) === q.correct) {
                    opt.classList.add('correct');
                } else if (opt.textContent === String(answer)) {
                    opt.classList.add('wrong');
                }
            });
            
            if (correct) {
                correctAnswers++;
                const earnedPoints = boostEnabled ? 15 : 10;
                points += earnedPoints;
                document.getElementById('feedback').textContent = `‚úÖ Correct! +${earnedPoints} points`;
            } else {
                wrongAnswers++;
                points = Math.max(0, points - 1);
                document.getElementById('feedback').textContent = `‚ùå Wrong! Answer was ${q.correct}. -1 point`;
            }
            
            document.getElementById('feedback').classList.remove('hidden');
            
            setTimeout(() => {
                currentQuestion++;
                document.getElementById('feedback').classList.add('hidden');
                
                if (currentQuestion < 5) {
                    showQuestion();
                } else {
                    showResults();
                }
            }, 2000);
        }
        
        function showResults() {
            document.getElementById('quizPlay').classList.add('hidden');
            document.getElementById('quizResults').classList.remove('hidden');
            
            document.getElementById('correctCount').textContent = correctAnswers;
            document.getElementById('pointsEarned').textContent = points;
            document.getElementById('wrongCount').textContent = wrongAnswers;
            
            if (userAddr) {
                document.getElementById('pendingPointsItem').classList.remove('hidden');
                document.getElementById('pendingPoints').textContent = points;
            }
        }
        
        function playAgain() {
            document.getElementById('quizResults').classList.add('hidden');
            document.getElementById('saveMessage').classList.add('hidden');
            document.getElementById('quizStart').classList.remove('hidden');
        }
        
        async function saveScore() {
            const msg = document.getElementById('saveMessage');
            if (!userAddr || !quiz) {
                msg.className = 'message warning';
                msg.textContent = '‚ö†Ô∏è Connect your bank first! Switch to the Bank tab above.';
                msg.classList.remove('hidden');
                return;
            }
            
            try {
                let pts = points;
                if (boostEnabled && musdBalance >= 1) {
                    pts = Math.floor(pts * 1.5);
                }
                
                msg.className = 'message info';
                msg.textContent = '‚è≥ Saving to blockchain...';
                msg.classList.remove('hidden');
                
                const tx = await quiz.updateScore(userAddr, pts);
                await tx.wait();
                
                msg.className = 'message success';
                msg.textContent = `‚úÖ Saved! ${pts} points added to your bank!`;
                
                document.getElementById('pendingPoints').textContent = '0';
                document.getElementById('pendingPointsItem').classList.add('hidden');
                
                if (boostEnabled) {
                    document.getElementById('boostToggle').checked = false;
                    boostEnabled = false;
                }
                
                setTimeout(() => {
                    refreshBankData();
                    loadLeaderboard();
                }, 1000);
                
            } catch (err) {
                msg.className = 'message error';
                msg.textContent = `‚ùå Failed: ${err.message}\n\nMake sure you have tBTC for gas: faucet.test.mezo.org`;
                msg.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
